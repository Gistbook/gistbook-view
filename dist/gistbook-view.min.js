this.gistbookTemplates=this.gistbookTemplates||{},this.gistbookTemplates.aceEditorView=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<div class="ace-wrapper">\n  <div class="ace-editor">'+(null==(__t=source)?"":__t)+"</div>\n</div>\n";return __p},this.gistbookTemplates.controlsWrapper=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<div class='gistbook-row-controls'>\n  <hr>\n  <ul>\n    <li>\n      <a href='#' class='add-text'>\n        <span class=\"fa-stack\">\n          <i class=\"fa fa-circle fa-stack-2x\"></i>\n          <i class=\"fa fa-font fa-stack-1x\"></i>\n        </span>\n      </a>\n    </li>\n    <li>\n      <a href='#' class='add-javascript'>\n        <span class=\"fa-stack\">\n          <i class=\"fa fa-circle fa-stack-2x\"></i>\n          <i class=\"fa fa-code fa-stack-1x\"></i>\n        </span>\n      </a>\n    </li>\n  </ul>\n</div>\n<div class='gistblock-wrapper'>\n</div>\n";return __p},this.gistbookTemplates.editWrapper=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+="<ul>\n  <li><a href='#' class='gistblock-code active-tab'>"+(null==(__t=sourceTabText)?"":__t)+"</a></li>\n  <li><a href='#' class='gistblock-preview'>Preview</a></li>\n</ul>\n<div class='gistblock-content'></div>\n<div class='button-container'>\n  <button class='gistblock-cancel'>Cancel</button>\n  <button class='gistblock-update blue'>Update</button>\n</div>\n";return __p},this.gistbookTemplates.menuWrapper=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<a href='#' class='gistblock-move'><i class='fa fa-bars'></i></a>\n<a href='#' class='gistblock-edit'><i class='fa fa-pencil'></i></a>\n<a href='#' class='gistblock-delete'><i class='fa fa-trash-o'></i></a>\n<div class='gistblock-content'></div>\n";return __p},this.gistbookTemplates.gistbookView=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+="<div class='gistbook-header'>\n  <h1>"+(null==(__t=title)?"":__t)+"</h1>\n</div>\n<ul class='gistbook-container'>\n</ul>\n";return __p},function(){var a=Backbone.Radio;!function(a){var b,c=a();a.fn.sortable=function(d){var e=String(d);return d=a.extend({connectWith:!1},d),this.each(function(){if(/^enable|disable|destroy$/.test(e)){var f=a(this).children(a(this).data("items")).attr("draggable","enable"==e);return void("destroy"==e&&f.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"))}var g,h,f=a(this).children(d.items),i=a("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');f.find(d.handle).mousedown(function(){g=!0}).mouseup(function(){g=!1}),a(this).data("items",d.items),c=c.add(i),d.connectWith&&a(d.connectWith).add(this).data("connectWith",d.connectWith),f.attr("draggable","true").on("dragstart.h5s",function(c){if(d.handle&&!g)return!1;g=!1;var e=c.originalEvent.dataTransfer;e.effectAllowed="move",e.setData("Text","dummy"),h=(b=a(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){b&&(b.removeClass("sortable-dragging").show(),c.detach(),h!=b.index()&&b.parent().trigger("sortupdate",{item:b}),b=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,i]).on("dragover.h5s dragenter.h5s drop.h5s",function(e){return f.is(b)||d.connectWith===a(b).parent().data("connectWith")?"drop"==e.type?(e.stopPropagation(),c.filter(":visible").after(b),b.trigger("dragend.h5s"),!1):(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",f.is(this)?(d.forcePlaceholderSize&&i.height(b.outerHeight()),b.hide(),a(this)[i.index()<a(this).index()?"after":"before"](i),c.not(i).detach()):c.is(this)||a(this).children(d.items).length||(c.detach(),a(this).append(i)),!1):!0})})}}(jQuery);var b=function(a,b){_.extend(this,_.pick(a,b))};Marionette.View.prototype.mergeOptions=b,Marionette.Object.prototype.mergeOptions=b,Marionette.Application.prototype._initChannel=function(){this.channelName=_.result(this,"channelName")||"global",this.channel=_.result(this,"channel")||a.channel(this.channelName)},Marionette.View.prototype.serializeModel=function(a){return a=a||this.model,_.clone(a.attributes)},Marionette.ItemView.prototype.serializeCollection=function(){return collection.map(function(a){return this.serializeModel(a)},this)};var c={capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}},d={entityChannelName:function(a){return"gistbook-"+a.uniqueId},entityChannel:function(b){return a.channel(d.entityChannelName(b))}},e=Marionette.Object.extend({initialize:function(a){_.bindAll(this,"_addBlock"),this.collection=a.collection,this.gistbookCh=d.entityChannel(this.collection),this._configureListeners()},_configureListeners:function(){this.listenTo(this.gistbookCh,"add:block",this._addBlock)},_addBlock:function(a,b){var c=this.collection.indexOf(b);if(-1!==c){var d=new Backbone.Model({type:a,source:""});this.collection.add(d,{at:c})}}}),f=Marionette.CompositeView.extend({template:gistbookTemplates.gistbookView,ui:{container:".gistbook-container"},className:"gistbook",childViewContainer:".gistbook-container",childView:Marionette.ItemView,initialize:function(b){_.bindAll(this,"_resortByDom");var c=b.model.get("blocks");this.initialRender=!1,this.collection=new Backbone.Collection(c),this.collection.uniqueId=_.uniqueId(),this.cacheManager=new e({collection:this.collection}),this.authorized=a.request("auth","authorized"),this.gistbookCh=d.entityChannel(this.collection)},getChildView:function(a){var b=this._generatorMethodName(a.get("type"));return this[b](a)},onRender:function(){this.initialRender=!0,this._setUpSortable()},onBeforeDestroy:function(){this.ui.container.sortable("destroy")},_generatorMethodName:function(a){return"_get"+c.capitalize(a)+"View"},_setUpSortable:function(){this.authorized&&(this.ui.container.sortable({handle:".gistblock-move"}),this.ui.container.on("sortupdate",_.bind(this._resortByDom,this)))},_getTextView:function(a){if(this.authorized){this._registerDisplayView(a,h);var b=this.initialRender?"active":"inert";return this.childViewOptions={initialMode:b},l}return this.childViewOptions={},h.extend({tagName:"li"})},_getJavascriptView:function(a){if(this.authorized){var b=g.extend({className:"gistblock gistblock-javascript"});return this._registerDisplayView(a,b),this.childViewOptions={editOptions:{edit:!1,move:!0,"delete":!0}},l}return this.childViewOptions={readOnly:!0,hideCursor:!0,className:"gistblock gistblock-javascript"},g.extend({tagName:"li"})},_registerDisplayView:function(a,b){d.entityChannel(a).reply("displayView",function(a){return new b(a)})},_resortByDom:function(){var a,b={},c=[];this.children.each(function(d){a=this.ui.container.children().index(d.el),b[a]=d.model,c=_.sortBy(b,function(a,b){return b}),d._index=a},this),this.collection.reset(c,{silent:!0})}}),g=Marionette.ItemView.extend({template:gistbookTemplates.aceEditorView,readOnly:!1,tabSize:2,softTabs:!0,highlightActiveLine:!1,theme:"tomorrow",mode:"javascript",minLines:5,maxLines:20,hideCursor:!1,showGutter:!1,aceEditorViewOptions:["readOnly","tabSize","softTabs","highlightActiveLine","theme","mode","minLines","maxLines","hideCursor","showGutter"],ui:{aceContainer:".ace-editor"},initialize:function(a){this.mergeOptions(a,this.aceEditorViewOptions)},onRender:function(){this.editor=ace.edit(this.ui.aceContainer[0]),this._configureEditor()},onBeforeDestroy:function(){this.editor.destroy()},_configureEditor:function(){var a=this._getThemePath(this.theme),b=this._getModePath(this.mode),c=this.editor.getSession(),d=this.editor.renderer;this.editor.setHighlightActiveLine(this.highlightActiveLine),this.editor.getSession().setMode(b),this.editor.setTheme(a),this.editor.setOption("maxLines",this.maxLines),this.editor.setOption("minLines",this.minLines),this.editor.setReadOnly(this.readOnly),c.setTabSize(this.tabSize),c.setUseSoftTabs(this.softTabs),d.setShowGutter(this.showGutter),this.hideCursor&&(d.$cursorLayer.element.style.opacity=0)},_getThemePath:function(a){return"ace/theme/"+a},_getModePath:function(a){return"ace/mode/"+a}}),h=Marionette.ItemView.extend({template:_.template(""),className:"gistblock gistblock-text",initialize:function(){_.bindAll(this,"_parseMarked")},onRender:function(){var a=this.model.escape("source");a&&(this.$el.html(a),this._parseText(a))},_parseText:function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.$el[0]]),MathJax.Hub.Queue(this._parseMarked)},_parseMarked:function(){var a=this.$el;marked(a.html(),function(b,c){a.html(c)})}}),i=Marionette.ItemView.extend({template:_.template("<%= source %>"),tagName:"textarea",className:"gistbook-textarea",value:function(){return this.el.value}}),j=Marionette.LayoutView.extend({template:gistbookTemplates.menuWrapper,className:"gistblock-menu",menuWrapperOptions:["blockChannel","editOptions"],editOptions:{edit:!0,"delete":!0,move:!0},regions:{content:".gistblock-content"},ui:{content:".gistblock-content",edit:".gistblock-edit",move:".gistblock-move","delete":".gistblock-delete"},triggers:{"click @ui.edit":"edit","click @ui.move":"move","click @ui.delete":"delete"},initialize:function(a){this.mergeOptions(a,this.menuWrapperOptions)},getInertView:function(){return this.blockChannel.request("displayView",{model:this.model})},onRender:function(){this._showMenu();var a=this.getRegion("content"),b=this.getInertView();a.show(b)},_showMenu:function(){_.each(this.editOptions,function(a,b){this.ui[b].toggleClass("active-option",a)},this)}}),k=Marionette.LayoutView.extend({template:gistbookTemplates.editWrapper,className:"gistblock-editor",tagName:"li",defaults:{sourceTabText:"Write",PreviewView:void 0,blockChannel:void 0},sourceTabText:"Write",editWrapperOptions:["sourceTabText","PreviewView","blockChannel"],initialize:function(a){this.mergeOptions(a,this.editWrapperOptions),this.cache=this.model.toJSON(),this.mode="code"},serializeData:function(){var a=Marionette.ItemView.prototype.serializeData.call(this);return a.sourceTabText=this.sourceTabText,a},ui:{content:".gistblock-content",code:".gistblock-code",preview:".gistblock-preview",cancel:".gistblock-cancel",update:".gistblock-update"},triggers:{"click @ui.code":"code","click @ui.preview":"preview","click @ui.cancel":"cancel","click @ui.update":"update"},onPreview:function(){"preview"!==this.mode&&(this._setCache(),this.transitionUiToPreview(),this.triggerMethod("updateCache"),this.showPreview(),this.mode="preview")},onCode:function(){"code"!==this.mode&&(this.transitionUiToCode(),this.mode="code",this.showEditor())},onUpdate:function(){"preview"!==this.mode&&this._setCache()},transitionUiToPreview:function(){this.ui.code.removeClass("active-tab"),this.ui.preview.addClass("active-tab")},transitionUiToCode:function(){this.ui.preview.removeClass("active-tab"),this.ui.code.addClass("active-tab")},getTextEditorView:function(){return new i({model:this.model})},getPreviewView:function(){return this.blockChannel.request("displayView",{model:this.model})},showEditor:function(){var a=this.getTextEditorView(),b=this.getRegion("content");b.show(a),this._setCache()},showPreview:function(){this._setCache();var a=this.getRegion("content"),b=this.getPreviewView();a.show(b)},regions:{content:".gistblock-content"},onRender:function(){this._showMenu(),this.showEditor()},_setCache:function(){var a=this.getRegion("content");this.cache=a.currentView.value()},_showMenu:function(){_.each(this.editOptions,function(a,b){this.ui[b].toggleClass("active-option",a)},this)}}),l=Marionette.LayoutView.extend({template:gistbookTemplates.controlsWrapper,className:"controls-wrapper-view",tagName:"li",initialMode:"inert",editOptions:{edit:!0,"delete":!0,move:!0},controlsWrapperOptions:["editOptions","initialMode"],regions:{wrapper:".gistblock-wrapper"},ui:{addText:".add-text",addJavascript:".add-javascript"},triggers:{"click @ui.addText":"add:text","click @ui.addJavascript":"add:javascript"},initialize:function(a){this.mergeOptions(a,this.controlsWrapperOptions),_.bindAll(this,"onEdit","onDelete","onCancel","onUpdate","onAddText","onAddJavascript"),this._createCache(),this.gistbookCh=d.entityChannel(this.model.collection)},onEdit:function(){this.showActive()},onDelete:function(){this.model.collection.remove(this.model)},onCancel:function(){this._resetCache(),this.showInert()},onAddText:function(){this.gistbookCh.trigger("add:block","text",this.model)},onAddJavascript:function(){this.gistbookCh.trigger("add:block","javascript",this.model)},showInert:function(){this.stopListening();var a=this.getMenuWrapper();this.getRegion("wrapper").show(a),this.currentView=a,this._configurePreviewListeners()},showActive:function(){this.stopListening();var a=this.getEditWrapper();this.getRegion("wrapper").show(a),this.currentView=a,this._configureEditListeners()},onUpdate:function(){this._updateCache(),this._saveCache(),this.showInert()},onRender:function(){"active"===this.initialMode?this.showActive():this.showInert()},getMenuWrapper:function(){return new j({editOptions:this.editOptions,model:this.cachedModel,blockChannel:d.entityChannel(this.model)})},getEditWrapper:function(){return new k({model:this.cachedModel,blockChannel:d.entityChannel(this.model),aceEditorOptions:{minLines:4}})},_createCache:function(){this.cachedModel=new Backbone.Model(this.model.toJSON())},_saveCache:function(){this.model.set(this.cachedModel.toJSON())},_resetCache:function(){this.cachedModel.set(this.model.toJSON())},_updateCache:function(){var a=this.getRegion("wrapper").currentView.cache;this.cachedModel.set("source",a)},_configureEditListeners:function(){this.listenTo(this.currentView,"cancel",this.onCancel),this.listenTo(this.currentView,"update",this.onUpdate),this.listenTo(this.currentView,"updateCache",this._updateCache)},_configurePreviewListeners:function(){this.listenTo(this.currentView,"edit",this.onEdit),this.listenTo(this.currentView,"delete",this.onDelete)}});window.GistbookView=f}();
//# sourceMappingURL=gistbook-view.min.map