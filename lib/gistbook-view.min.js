this.gistbookTemplates=this.gistbookTemplates||{},this.gistbookTemplates.editWrapper=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+="<ul>\n  <li><a href='#' class='gistblock-code active-tab'>"+(null==(__t=sourceTabText)?"":__t)+"</a></li>\n  <li><a href='#' class='gistblock-preview'>Preview</a></li>\n</ul>\n<div class='gistblock-content'></div>\n<div class='button-container'>\n  <button class='gistblock-cancel'>Cancel</button>\n  <button class='gistblock-update blue'>Update</button>\n</div>\n";return __p},this.gistbookTemplates.menuWrapper=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<a href='#' class='gistblock-move'><i class='fa fa-bars'></i></a>\n<a href='#' class='gistblock-edit'><i class='fa fa-pencil'></i></a>\n<a href='#' class='gistblock-delete'><i class='fa fa-trash-o'></i></a>\n<div class='gistblock-content'></div>\n";return __p},this.gistbookTemplates.processedEditView=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<div class='gistbook-row-controls'>\n  <hr>\n  <ul>\n    <li>\n      <a href='#' class='add-text'>\n        <span class=\"fa-stack\">\n          <i class=\"fa fa-circle fa-stack-2x\"></i>\n          <i class=\"fa fa-font fa-stack-1x\"></i>\n        </span>\n      </a>\n    </li>\n    <li>\n      <a href='#' class='add-javascript'>\n        <span class=\"fa-stack\">\n          <i class=\"fa fa-circle fa-stack-2x\"></i>\n          <i class=\"fa fa-code fa-stack-1x\"></i>\n        </span>\n      </a>\n    </li>\n  </ul>\n</div>\n<div class='gistblock-wrapper'>\n</div>\n";return __p},this.gistbookTemplates.gistbookView=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+="<div class='gistbook-header'>\n  <h1>"+(null==(__t=title)?"":__t)+"</h1>\n</div>\n<ul class='gistbook-container'>\n</ul>\n";return __p},function(){var a=Backbone.Wreqr.radio;!function(a){var b,c=a();a.fn.sortable=function(d){var e=String(d);return d=a.extend({connectWith:!1},d),this.each(function(){if(/^enable|disable|destroy$/.test(e)){var f=a(this).children(a(this).data("items")).attr("draggable","enable"==e);return void("destroy"==e&&f.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"))}var g,h,f=a(this).children(d.items),i=a("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');f.find(d.handle).mousedown(function(){g=!0}).mouseup(function(){g=!1}),a(this).data("items",d.items),c=c.add(i),d.connectWith&&a(d.connectWith).add(this).data("connectWith",d.connectWith),f.attr("draggable","true").on("dragstart.h5s",function(c){if(d.handle&&!g)return!1;g=!1;var e=c.originalEvent.dataTransfer;e.effectAllowed="move",e.setData("Text","dummy"),h=(b=a(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){b&&(b.removeClass("sortable-dragging").show(),c.detach(),h!=b.index()&&b.parent().trigger("sortupdate",{item:b}),b=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,i]).on("dragover.h5s dragenter.h5s drop.h5s",function(e){return f.is(b)||d.connectWith===a(b).parent().data("connectWith")?"drop"==e.type?(e.stopPropagation(),c.filter(":visible").after(b),b.trigger("dragend.h5s"),!1):(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",f.is(this)?(d.forcePlaceholderSize&&i.height(b.outerHeight()),b.hide(),a(this)[i.index()<a(this).index()?"after":"before"](i),c.not(i).detach()):c.is(this)||a(this).children(d.items).length||(c.detach(),a(this).append(i)),!1):!0})})}}(jQuery);var b=Marionette.CompositeView.extend({initialize:function(b){_.bindAll(this,"resortByDom");var d=b.model.get("blocks");this.initialRender=!1,this.collection=new Backbone.Collection(d),this.collection.uniqueId=_.uniqueId(),this.cacheController=new c({collection:this.collection}),this.authorized=a.reqres.request("global","authorized"),this.gistbookCh=a.channel(channelName(this.collection))},resortByDom:function(){var a,b={},c=[];this.children.each(function(d){a=this.ui.container.children().index(d.el),b[a]=d.model,c=_.sortBy(b,function(a,b){return b}),d._index=a},this),this.collection.reset(c,{silent:!0})},template:gistbookTemplates.gistbookView,ui:{container:".gistbook-container"},childViewContainer:".gistbook-container",childView:Marionette.ItemView.extend({template:_.template("")}),className:"gistbook",getChildView:function(a){var b=a.get("type");return this["_"+b+"View"]()},_textView:function(){return this.authorized?(this.childViewOptions={InertView:e},this.childViewOptions.initialMode=this.initialRender?"active":"inert",i):(this.childViewOptions={},e.extend({tagName:"li"}))},onRender:function(){this.initialRender=!0,this._setUpSortable()},_setUpSortable:function(){this.authorized&&(this.ui.container.sortable({handle:".gistblock-move"}),this.ui.container.on("sortupdate",_.bind(this.resortByDom,this)))},_javascriptView:function(){if(this.authorized){var a=d.extend({className:"gistblock gistblock-javascript"});return this.childViewOptions={InertView:a,editOptions:{edit:!1,"delete":!0,move:!0}},i}return this.childViewOptions={readOnly:!0,hideCursor:!0,className:"gistblock gistblock-javascript"},d.extend({tagName:"li"})},onBeforeDestroy:function(){this.ui.container.sortable("destroy")}});window.channelName=function(a){return a=a instanceof Backbone.Model?a.collection:a,"gistbook-"+a.uniqueId};var c=Marionette.Controller.extend({initialize:function(b){_.bindAll(this,"_addBlock"),this.collection=b.collection,this.gistbookCh=a.channel(channelName(this.collection)),this._configureListeners()},_configureListeners:function(){this.listenTo(this.gistbookCh.vent,"add:block",this._addBlock)},_addBlock:function(a,b){var c=this.collection.indexOf(b);if(-1!==c){var d=new Backbone.Model({type:a,source:""});this.collection.add(d,{at:c})}}}),d=Marionette.ItemView.extend({template:_.template('<div class="ace-wrapper"><div class="ace-editor"><%= source %></div></div>'),defaults:{readOnly:!1,tabSize:2,softTabs:!0,highlightActiveLine:!1,theme:"tomorrow",mode:"javascript",minLines:5,maxLines:20,hideCursor:!1,showGutter:!1},ui:{aceContainer:".ace-editor"},initialize:function(a){var b=_.keys(this.defaults);_.extend(this,this.defaults,_.pick(a,b))},_getThemePath:function(a){return"ace/theme/"+a},_getModePath:function(a){return"ace/mode/"+a},_configureEditor:function(){var a=this._getThemePath(this.theme),b=this._getModePath(this.mode),c=this.editor.getSession(),d=this.editor.renderer;this.editor.setHighlightActiveLine(this.highlightActiveLine),this.editor.getSession().setMode(b),this.editor.setTheme(a),this.editor.setOption("maxLines",this.maxLines),this.editor.setOption("minLines",this.minLines),this.editor.setReadOnly(this.readOnly),c.setTabSize(this.tabSize),c.setUseSoftTabs(this.softTabs),d.setShowGutter(this.showGutter),this.hideCursor&&(d.$cursorLayer.element.style.opacity=0)},onRender:function(){this.editor=ace.edit(this.ui.aceContainer[0]),this._configureEditor()},onBeforeDestroy:function(){this.editor.destroy()}}),e=Marionette.ItemView.extend({template:_.template(""),className:"gistblock gistblock-text",onRender:function(){var a=this.model.get("source"),b=this.$el;a&&(b.html(a),MathJax.Hub.Queue(["Typeset",MathJax.Hub,b[0]]),MathJax.Hub.Queue(function(){marked(b.html(),function(a,c){b.html(c)})}))}}),f=Marionette.ItemView.extend({template:_.template("<%= source %>"),tagName:"textarea",className:"gistbook-textarea",value:function(){return this.el.value}}),g=Marionette.LayoutView.extend({template:gistbookTemplates.menuWrapper,className:"gistblock-menu",defaults:{InertView:void 0,editOptions:{edit:!0,"delete":!0,move:!0}},ui:{content:".gistblock-content",edit:".gistblock-edit",move:".gistblock-move","delete":".gistblock-delete"},triggers:{"click @ui.edit":"edit","click @ui.move":"move","click @ui.delete":"delete"},initialize:function(a){var b=_.keys(this.defaults);_.extend(this,this.defaults,_.pick(a,b))},regions:{content:".gistblock-content"},onRender:function(){this._showMenu();var a=this.getRegion("content");a.show(new this.InertView({model:this.model}))},_showMenu:function(){_.each(this.editOptions,function(a,b){this.ui[b].toggleClass("active-option",a)},this)}}),h=Marionette.LayoutView.extend({template:gistbookTemplates.editWrapper,className:"gistblock-editor",tagName:"li",defaults:{sourceTabText:"Code",PreviewView:void 0,parent:void 0},serializeData:function(){var a=Marionette.ItemView.prototype.serializeData.call(this);return a.sourceTabText=this.sourceTabText,a},ui:{content:".gistblock-content",code:".gistblock-code",preview:".gistblock-preview",cancel:".gistblock-cancel",update:".gistblock-update"},triggers:{"click @ui.code":"code","click @ui.preview":"preview","click @ui.cancel":"cancel","click @ui.update":"update"},onPreview:function(){"preview"!==this.mode&&(this._updateCache(),this.transitionUiToPreview(),this.parent._updateCache(),this.showPreview(),this.mode="preview")},onCode:function(){"code"!==this.mode&&(this.transitionUiToCode(),this.mode="code",this.showEditor())},onUpdate:function(){"preview"!==this.mode&&this._updateCache()},transitionUiToPreview:function(){this.ui.code.removeClass("active-tab"),this.ui.preview.addClass("active-tab")},transitionUiToCode:function(){this.ui.preview.removeClass("active-tab"),this.ui.code.addClass("active-tab")},_updateCache:function(){"preview"===this.mode&&console.log("Warning: cache updated on preview");var a=this.getRegion("content");this.cache=a.currentView.value()},getTextEditorView:function(){return new f({model:this.model})},showEditor:function(){var a=this.getTextEditorView(),b=this.getRegion("content");b.show(a),this._updateCache()},showPreview:function(){this._updateCache();var a=this.getRegion("content");a.show(new this.PreviewView({model:this.model}))},initialize:function(a){var b=_.keys(this.defaults);_.extend(this,this.defaults,_.pick(a,b)),this.cache=this.model.toJSON(),this.mode="code"},regions:{content:".gistblock-content"},onRender:function(){this._showMenu(),this.showEditor()},_showMenu:function(){_.each(this.editOptions,function(a,b){this.ui[b].toggleClass("active-option",a)},this)}}),i=Marionette.LayoutView.extend({template:gistbookTemplates.processedEditView,className:"processed-edit-view",tagName:"li",defaults:{InertView:void 0,initialMode:"inert",editOptions:{edit:!0,"delete":!0,move:!0}},ui:{addText:".add-text",addJavascript:".add-javascript"},triggers:{"click @ui.addText":"add:text","click @ui.addJavascript":"add:javascript"},onAddText:function(){this.gistbookCh.vent.trigger("add:block","text",this.model)},onAddJavascript:function(){this.gistbookCh.vent.trigger("add:block","javascript",this.model)},initialize:function(b){var c=_.keys(this.defaults);_.extend(this,this.defaults,_.pick(b,c)),_.bindAll(this,"onEdit","onDelete","onCancel","onUpdate","onAddText","onAddJavascript"),this._createCache(),this.gistbookCh=a.channel(channelName(this.model))},_createCache:function(){this.cachedModel=new Backbone.Model(this.model.toJSON())},_saveCache:function(){this.model.set(this.cachedModel.toJSON())},_resetCache:function(){this.cachedModel.set(this.model.toJSON())},_updateCache:function(){var a=this.getRegion("wrapper").currentView.cache;this.cachedModel.set("source",a)},regions:{wrapper:".gistblock-wrapper"},onEdit:function(){this.showActive()},showInert:function(){this.stopListening(),this.getRegion("wrapper").show(new g({InertView:this.InertView,editOptions:this.editOptions,model:this.cachedModel})),this.currentView=this.getRegion("wrapper").currentView,this._configurePreviewListeners()},showActive:function(){this.stopListening();var a=this.getRegion("wrapper");a.show(new h({PreviewView:this.InertView,model:this.cachedModel,aceEditorOptions:{minLines:4},parent:this})),this.currentView=a.currentView,this._configureEditListeners()},onDelete:function(){this.model.collection.remove(this.model)},onCancel:function(){this._resetCache(),this.showInert()},onUpdate:function(){this._updateCache(),this._saveCache(),this.showInert()},onRender:function(){"active"===this.initialMode?this.showActive():this.showInert()},_configureEditListeners:function(){this.listenTo(this.currentView,"cancel",this.onCancel),this.listenTo(this.currentView,"update",this.onUpdate)},_configurePreviewListeners:function(){this.listenTo(this.currentView,"edit",this.onEdit),this.listenTo(this.currentView,"delete",this.onDelete)}});window.GistbookView=b}();
//# sourceMappingURL=gistbook-view.min.map